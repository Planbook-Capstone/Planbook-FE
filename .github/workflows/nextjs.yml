echo "📥 Pulling latest code..."
cd /root/fe/Planbook-FE
git reset --hard
git pull origin main || git pull origin master

echo "🛑 Stopping old container if running..."
docker stop planbook-app || true
docker rm planbook-app || true

echo "🏗️ Building and starting container..."
docker compose -f docker-compose.yml up -d --build

echo "⏳ Waiting for container to start..."
sleep 20

echo "🔍 Performing health check..."
if curl -f http://localhost:3000/health || curl -f http://localhost:3000; then
  echo "✅ Deployment successful!"
  docker image prune -f
else
  echo "❌ Health check failed! Stopping container..."
  docker stop planbook-app || true
  exit 1
fi
